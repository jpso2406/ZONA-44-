<app-navbar></app-navbar>   

<div class="perfil-container">
<!-- 🔹 Overlay de carga profesional -->
<div *ngIf="loading" class="loading-overlay">
  <div class="loader-wrapper">
    <div class="dots">
      <span></span>
      <span></span>
      <span></span>
    </div>
    <p>{{ 'PROFILE.UPDATING_PROFILE' | translate }}</p>
  </div>
</div>

  <!-- ===== ENCABEZADO PRINCIPAL ===== -->
  <header class="perfil-header">
    <div class="header-content">
      <h1>{{ 'PROFILE.TITLE' | translate }}</h1>
      <p class="subtitle">{{ 'PROFILE.SUBTITLE' | translate }}</p>
    </div>
  </header>

  <!-- ===== INDICADOR DE CARGA ===== -->
  <section *ngIf="loading && !currentUser" class="loading-container">
    <div class="loader">
      <div class="spinner"></div>
      <p>{{ 'PROFILE.LOADING_PROFILE' | translate }}</p>
    </div>
  </section>

  <!-- 🔹 Contenido del perfil -->
  <main *ngIf="currentUser && !loading" class="perfil-content" [ngClass]="{ 'orders-active': showOrdersView }">

    <!-- 🧍 Tarjeta de perfil -->
    <section *ngIf="!showOrdersView" class="profile-card">

      <!-- Encabezado del perfil -->
      <div class="profile-header">
        <div class="avatar">
          <i class="fas fa-user"></i>
        </div>

        <div class="profile-info">
          <h2>{{ currentUser.first_name }} {{ currentUser.last_name }}</h2>
          <p class="email">{{ currentUser.email }}</p>
          <span class="role-badge">{{ currentUser.role || ('PROFILE.ROLE' | translate) }}</span>
        </div>

        <!-- Acciones del perfil -->
        <div class="profile-actions">
          <ng-container *ngIf="!isEditing; else editingButtons">
            <button class="btn-edit" (click)="toggleEdit()">
              <i class="fas fa-edit"></i>
              <span>{{ 'PROFILE.EDIT' | translate }}</span>
            </button>
          </ng-container>

          <ng-template #editingButtons>
            <div class="edit-actions">
              <button class="btn-save" (click)="saveProfile()" [disabled]="loading">
                <i *ngIf="!loading" class="fas fa-save"></i>
                <i *ngIf="loading" class="fas fa-spinner fa-spin"></i>
                <span>{{ loading ? ('PROFILE.SAVING' | translate) : ('PROFILE.SAVE' | translate) }}</span>
              </button>
              <button class="btn-cancel" (click)="cancelEdit()">
                <i class="fas fa-times"></i>
                <span>{{ 'PROFILE.CANCEL' | translate }}</span>
              </button>
            </div>
          </ng-template>
        </div>
      </div>
      <!-- Fin profile-header -->

      <!-- Detalles del perfil -->
      <div class="profile-details">

        <!-- Información personal -->
        <div class="detail-section">
          <h3><i class="fas fa-user"></i> {{ 'PROFILE.PERSONAL_INFO' | translate }}</h3>
          <div class="detail-grid">

            <div class="detail-item">
              <label>{{ 'PROFILE.FIRST_NAME' | translate }}</label>
              <ng-container *ngIf="!isEditing; else editNombre">
                <p class="detail-value">{{ currentUser.first_name }}</p>
              </ng-container>
              <ng-template #editNombre>
                <input type="text" [(ngModel)]="editForm.first_name" name="first_name" (input)="filterText($event)" class="form-control">
              </ng-template>
            </div>

            <div class="detail-item">
              <label>{{ 'PROFILE.LAST_NAME' | translate }}</label>
              <ng-container *ngIf="!isEditing; else editApellido">
                <p class="detail-value">{{ currentUser.last_name }}</p>
              </ng-container>
              <ng-template #editApellido>
                <input type="text" [(ngModel)]="editForm.last_name" name="last_name" (input)="filterText($event)" class="form-control">
              </ng-template>
            </div>

            <div class="detail-item">
              <label>{{ 'PROFILE.EMAIL' | translate }}</label>
              <ng-container *ngIf="!isEditing; else editEmail">
                <p class="detail-value">{{ currentUser.email }}</p>
              </ng-container>
              <ng-template #editEmail>
                <input type="email" [(ngModel)]="editForm.email" name="email" class="form-control">
              </ng-template>
            </div>

            <div class="detail-item">
              <label>{{ 'PROFILE.PHONE' | translate }}</label>
              <ng-container *ngIf="!isEditing; else editTelefono">
                <p class="detail-value">{{ currentUser.phone }}</p>
              </ng-container>
              <ng-template #editTelefono>
                <input type="tel" [(ngModel)]="editForm.phone" name="phone" (input)="filterNumber($event)" class="form-control">
              </ng-template>
            </div>

          </div>
        </div>
        <!-- Fin Información personal -->

        <!-- Ubicación -->
        <div class="detail-section">
          <h3><i class="fas fa-map-marker-alt"></i> {{ 'PROFILE.LOCATION' | translate }}</h3>
          <div class="detail-grid">

            <div class="detail-item full-width">
              <label>{{ 'PROFILE.ADDRESS' | translate }}</label>
              <ng-container *ngIf="!isEditing; else editDireccion">
                <p class="detail-value">{{ currentUser.address }}</p>
              </ng-container>
              <ng-template #editDireccion>
                <input type="text" [(ngModel)]="editForm.address" name="address" (input)="filterText($event)" class="form-control">
              </ng-template>
            </div>

            <div class="detail-item">
              <label>{{ 'PROFILE.CITY' | translate }}</label>
              <ng-container *ngIf="!isEditing; else editCiudad">
                <p class="detail-value">{{ currentUser.city }}</p>
              </ng-container>
              <ng-template #editCiudad>
                <input type="text" [(ngModel)]="editForm.city" name="city" (input)="filterText($event)" class="form-control">
              </ng-template>
            </div>

            <div class="detail-item">
              <label>{{ 'PROFILE.DEPARTMENT' | translate }}</label>
              <ng-container *ngIf="!isEditing; else editDepartamento">
                <p class="detail-value">{{ currentUser.department }}</p>
              </ng-container>
              <ng-template #editDepartamento>
                <input type="text" [(ngModel)]="editForm.department" name="department" (input)="filterText($event)" class="form-control">
              </ng-template>
            </div>

          </div>
        </div>
        <!-- Fin Ubicación -->

      </div>
      <!-- Fin profile-details -->

      <!-- Mensajes -->
      <div *ngIf="error" class="alert alert-error">
        <i class="fas fa-exclamation-triangle"></i>
        <span>{{ error }}</span>
      </div>

      <div *ngIf="success" class="alert alert-success">
        <i class="fas fa-check-circle"></i>
        <span>{{ success }}</span>
      </div>

    </section>
    <!-- Fin profile-card -->

    <!-- ACCIONES RÁPIDAS -->
    <aside class="quick-actions" [ngClass]="showOrdersView ? 'ordenes-panel' : 'perfil-panel'">
      <div class="actions-grid">

        <!-- Panel Admin -->
        <button *ngIf="currentUser?.role === 'admin'" class="action-btn admin" (click)="goToAdmin()">
          <i class="fas fa-tools"></i>
          <span>{{ 'PROFILE.ADMIN_PANEL' | translate }}</span>
        </button>

        <!-- Mis Órdenes / Mi Perfil -->
        <button class="action-btn" (click)="toggleOrdersView()" [class.active]="showOrdersView">
          <i class="fas fa-history"></i>
          <span>{{ showOrdersView ? ('PROFILE.MY_PROFILE' | translate) : ('PROFILE.MY_ORDERS' | translate) }}</span>
        </button>

        <!-- Cerrar Sesión -->
        <button class="action-btn logout" (click)="logout()">
          <i class="fas fa-sign-out-alt"></i>
          <span>{{ 'PROFILE.LOGOUT' | translate }}</span>
        </button>

        <!-- Eliminar Cuenta -->
        <button class="action-btn danger" (click)="confirmDelete()">
          <i class="fas fa-user-slash"></i>
          <span>{{ 'PROFILE.DELETE_ACCOUNT' | translate }}</span>
        </button>

      </div>
    </aside>

    <!-- 🧾 Sección de órdenes -->
    <section *ngIf="showOrdersView" class="orders-section">
      <div class="orders-header">
        <p>{{ 'PROFILE.ORDERS.SUBTITLE' | translate }}</p>
        
        <!-- Barra de filtros -->
        <div class="filters-bar">
          <div class="search-box">
            <i class="fas fa-search"></i>
            <input 
              type="text" 
              [(ngModel)]="searchTerm" 
              (input)="onSearchChange()"
              [placeholder]="'PROFILE.ORDERS.SEARCH_PLACEHOLDER' | translate"
              class="search-input">
          </div>

          <div class="filter-actions">
            <select [(ngModel)]="selectedStatus" (change)="onStatusChange()" class="filter-select">
              <option value="all">{{ 'PROFILE.ORDERS.ALL_STATUS' | translate }}</option>
              <option value="pending">{{ 'PROFILE.ORDERS.STATUS.pending' | translate }}</option>
              <option value="paid">{{ 'PROFILE.ORDERS.STATUS.paid' | translate }}</option>
              <option value="preparing">{{ 'PROFILE.ORDERS.STATUS.preparing' | translate }}</option>
              <option value="ready">{{ 'PROFILE.ORDERS.STATUS.ready' | translate }}</option>
              <option value="delivered">{{ 'PROFILE.ORDERS.STATUS.delivered' | translate }}</option>
              <option value="cancelled">{{ 'PROFILE.ORDERS.STATUS.cancelled' | translate }}</option>
            </select>

            <select [(ngModel)]="sortBy" (change)="onSortChange()" class="filter-select">
              <option value="date">{{ 'PROFILE.ORDERS.SORT_BY_DATE' | translate }}</option>
              <option value="amount">{{ 'PROFILE.ORDERS.SORT_BY_AMOUNT' | translate }}</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Estados -->
      <div *ngIf="ordersLoading" class="orders-loading">
        <div class="loader">
          <div class="spinner"></div>
          <p>{{ 'PROFILE.ORDERS.LOADING' | translate }}</p>
        </div>
      </div>

      <div *ngIf="ordersError" class="alert alert-error">
        <i class="fas fa-exclamation-triangle"></i>
        <span>{{ ordersError }}</span>
      </div>

      <!-- Lista de órdenes -->
      <div *ngIf="!ordersLoading && !ordersError" class="orders-list">

        <!-- Vacío -->
        <div *ngIf="orders.length === 0" class="empty-orders">
          <i class="fas fa-shopping-bag"></i>
          <h3>{{ 'PROFILE.ORDERS.EMPTY_TITLE' | translate }}</h3>
          <p>{{ 'PROFILE.ORDERS.EMPTY_DESCRIPTION' | translate }}</p>
          <button class="btn-primary" (click)="goToMenu()">
            <i class="fas fa-utensils"></i><span>{{ 'PROFILE.ORDERS.VIEW_MENU' | translate }}</span>
          </button>
        </div>

        <!-- Grilla -->        <div *ngIf="filteredOrders.length > 0" class="orders-grid">
          <div *ngFor="let order of filteredAndPaginatedOrders" class="order-card" (click)="viewOrderDetails(order)">
            <div class="order-header">
              <div class="order-number">
                <i class="fas fa-receipt"></i><span>{{ order.order_number }}</span>
              </div>
              <div class="order-status" [ngClass]="getOrderStatusClass(order.status)">
                {{ getOrderStatusText(order.status) }}
              </div>
            </div>

            <div class="order-info">
              <p><i class="fas fa-calendar"></i>{{ formatDate(order.created_at) }}</p>
              <p><i class="fas fa-truck"></i>{{ getDeliveryTypeText(order.delivery_type) }}</p>
              <p><i class="fas fa-dollar-sign"></i>{{ order.total_amount | currency:'COP':'symbol':'1.0-0' }}</p>
            </div>

            <div class="order-items-preview">
              <div *ngFor="let item of order.order_items.slice(0, 2)" class="item-preview">
                <span>{{ item.quantity }}x {{ item.producto.name }}</span>
              </div>
              <div *ngIf="order.order_items.length > 2" class="more-items">
                +{{ order.order_items.length - 2 }} más
              </div>
            </div>

            <button class="btn-view-details">
              <i class="fas fa-eye"></i><span>{{ 'PROFILE.ORDERS.VIEW_DETAILS' | translate }}</span>
            </button>
          </div>
        </div>

        <!-- 🔹 PAGINACIÓN -->
        <div class="pagination-container" *ngIf="totalPages > 1">
          <button class="page-btn" [disabled]="currentPage === 1" (click)="changePage(currentPage - 1)">
            <i class="fas fa-chevron-left"></i>
          </button>

          <ng-container *ngFor="let page of [].constructor(totalPages); let i = index">
            <button 
              class="page-btn" 
              [class.active]="currentPage === i + 1" 
              (click)="changePage(i + 1)">
              {{ i + 1 }}
            </button>
          </ng-container>

          <button class="page-btn" [disabled]="currentPage === totalPages" (click)="changePage(currentPage + 1)">
            <i class="fas fa-chevron-right"></i>
          </button>
        </div>
        <!-- 🔹 FIN PAGINACIÓN -->

      </div>
    </section>
    <!-- Fin orders-section -->

  </main>
  <!-- Fin perfil-content -->

  <!-- 🔹 Modal de detalles de orden -->
  <div *ngIf="showOrderDetails && selectedOrder" class="modal-backdrop" (click)="closeOrderDetails()"></div>

  <div *ngIf="showOrderDetails && selectedOrder" class="order-details-modal">
    <header class="modal-header">
      <h3>{{ 'PROFILE.ORDERS.ORDER_DETAILS' | translate }}</h3>
    </header>

    <div class="modal-body">
      <div class="order-details-header">
        <div class="order-number">
          <i class="fas fa-receipt"></i><span>{{ selectedOrder.order_number }}</span>
        </div>
        <div class="order-status" [ngClass]="getOrderStatusClass(selectedOrder.status)">
          {{ getOrderStatusText(selectedOrder.status) }}
        </div>
      </div>

      <div class="order-details-info">
        <p><strong>{{ 'TRACKING.DATE' | translate }}:</strong> {{ formatDate(selectedOrder.created_at) }}</p>
        <p><strong>{{ 'TRACKING.DELIVERY_TYPE' | translate }}:</strong> {{ getDeliveryTypeText(selectedOrder.delivery_type) }}</p>
        <p><strong>{{ 'TRACKING.TOTAL' | translate }}:</strong> {{ selectedOrder.total_amount | currency:'COP':'symbol':'1.0-0' }}</p>
      </div>

      <div class="order-items-details">
        <h4>{{ 'PROFILE.ORDERS.PRODUCTS' | translate }}</h4>
        <div class="items-list">
          <div *ngFor="let item of selectedOrder.order_items" class="item-detail">
            <div class="item-info">
              <h5>{{ item.producto.name }}</h5>
              <p>{{ item.producto.descripcion }}</p>
            </div>
            <span class="item-quantity">{{ item.quantity }}x</span>
            <div class="item-prices">
              <span class="unit-price">{{ item.unit_price | currency:'COP':'symbol':'1.0-0' }}</span>
              <span class="total-price">{{ item.total_price | currency:'COP':'symbol':'1.0-0' }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <footer class="modal-footer">
      <button class="btn-close" (click)="closeOrderDetails()">
        <i class="fas fa-times"></i><span>{{ 'PROFILE.ORDERS.CLOSE' | translate }}</span>
      </button>
    </footer>
  </div>
</div>

<app-footer></app-footer>
