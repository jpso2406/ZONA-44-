<div class="encabezado">
  <h1><%= @grupo.nombre.upcase %></h1>
  <div class="botones-superiores">
    <%= link_to "Volver al menú", menu_general_path, class: "boton-amarillo" %>
    <%= link_to "Ver carrito", mostrar_carrito_path(grupo_id: @grupo.id, slug: @grupo.slug), class: "boton-amarillo" %>
  </div>
</div>

<div class="contenedor-productos">
  <% @productos.each do |producto| %>
    <div class="tarjeta-producto">
      <% if producto.foto.attached? %>
        <div class="foto">
          <%= image_tag producto.foto.variant(resize_to_limit: [250, 250]) %>
        </div>
      <% end %>

      <h3 class="nombre"><%= producto.name %></h3>

      <% if producto.descripcion.present? %>
        <p class="descripcion"><%= producto.descripcion %></p>
      <% end %>

      <p class="precio">$<%= number_with_delimiter(producto.precio, delimiter: '.') %></p>

      <button class="boton-amarillo"
        onclick="mostrarModal(
          '<%= j producto.name %>',
          '<%= j producto.descripcion %>',
          '<%= j(url_for(producto.foto.variant(resize_to_limit: [300, 400]))) if producto.foto.attached? %>',
          <%= producto.precio %>,
          <%= producto.id %>
        )">
        Ver detalle
      </button>
    </div>
  <% end %>
</div>

<!-- Meta CSRF token -->
<meta name="csrf-token" content="<%= form_authenticity_token %>">

<!-- Modal -->
<div id="modal-producto" class="modal" style="display: none;">
  <div class="modal-contenido">
    <span class="cerrar" onclick="cerrarModal()">&times;</span>
    <div id="modal-info">
      <!-- Contenido dinámico -->
    </div>
  </div>
</div>

<!-- JavaScript -->
<script>
  function mostrarModal(nombre, descripcion, fotoUrl, precio, productoId) {
    const precioFormateado = new Intl.NumberFormat('es-CO').format(precio);

    document.getElementById("modal-info").innerHTML = `
      <h2>${nombre}</h2>
      ${fotoUrl ? `<img src="${fotoUrl}" alt="${nombre}" style="width: 100%; border-radius: 10px; margin-bottom: 15px;" />` : ""}
      ${descripcion ? `<p>${descripcion}</p>` : ""}
      <p><strong>Precio:</strong> $${precioFormateado}</p>
      <button class="boton-amarillo" onclick="agregarAlCarrito(${productoId})">Agregar al carrito</button>
    `;
    document.getElementById("modal-producto").style.display = "block";
  }

  function cerrarModal() {
    document.getElementById("modal-producto").style.display = "none";
  }

  function agregarAlCarrito(id) {
    fetch("/carrito", {
      method: "POST",
      headers: {
        "Content-Type": "application/x-www-form-urlencoded",
        "X-CSRF-Token": document.querySelector('meta[name="csrf-token"]').content
      },
      body: `producto_id=${id}`
    }).then(response => {
      if (response.redirected) {
        window.location.href = response.url;
      } else {
        cerrarModal();
        alert("Producto agregado al carrito.");
      }
    });
  }

  window.onclick = function(event) {
    const modal = document.getElementById("modal-producto");
    if (event.target == modal) {
      cerrarModal();
    }
  }
</script>

<!-- CSS -->
<style>
body {
  font-family: 'Segoe UI', sans-serif;
  background-color: #f8f8f8;
  margin: 0;
  padding: 0;
}

.encabezado {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px;
  background-color: #222;
  color: white;
}

.encabezado h1 {
  margin: 0;
  font-size: 24px;
}

.botones-superiores {
  display: flex;
  gap: 10px;
}

.boton-amarillo {
  background-color: #FFD700;
  border: none;
  padding: 10px 16px;
  font-weight: bold;
  cursor: pointer;
  border-radius: 5px;
  transition: background-color 0.2s;
}

.boton-amarillo:hover {
  background-color: #e6c200;
}

.contenedor-productos {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 25px;
  padding: 30px;
}

.tarjeta-producto {
  background-color: white;
  border-radius: 15px;
  padding: 20px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.1);
  text-align: center;
}

.tarjeta-producto img {
  max-width: 100%;
  height: auto;
  border-radius: 10px;
}

.nombre {
  font-size: 18px;
  font-weight: bold;
  margin: 12px 0 5px;
}

.descripcion {
  font-size: 14px;
  color: #555;
  margin-bottom: 10px;
}

.precio {
  font-size: 16px;
  color: #333;
  font-weight: bold;
  margin-bottom: 10px;
}

.modal {
  position: fixed;
  z-index: 1000;
  padding-top: 60px;
  left: 0; top: 0;
  width: 100%; height: 100%;
  overflow: auto;
  background-color: rgba(0,0,0,0.6);
}

.modal-contenido {
  color: #111;
  background-color: #fff;
  margin: auto;
  padding: 20px;
  border-radius: 10px;
  width: 90%;
  max-width: 500px;
  position: relative;
  box-shadow: 0 4px 10px rgba(0,0,0,0.3);
}

.cerrar {
  color: #aaa;
  position: absolute;
  top: 10px; right: 15px;
  font-size: 28px;
  font-weight: bold;
  cursor: pointer;
}

.cerrar:hover,
.cerrar:focus {
  color: black;
  text-decoration: none;
}
</style>
