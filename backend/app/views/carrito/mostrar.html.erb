<!-- app/views/carrito/_carrito_premium.html.erb -->
<!-- Incluye FontAwesome si no lo tienes ya -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<div class="cart-page">

  <!-- TOP NAV -->
  <header class="cart-nav">
    <div class="cart-container">
      <div class="brand">
        <i class="fas fa-utensils"></i>
        <span>FastFoodX</span>
      </div>
      <div class="nav-actions">
        <%= link_to grupo_index_path, class: "nav-link" do %><i class="fas fa-list"></i> Men√∫<% end %>
        <%= link_to root_path, class: "nav-link" do %><i class="fas fa-house"></i> Inicio<% end %>
      </div>
    </div>
  </header>

  <!-- MAIN -->
  <div class="cart-container cart-grid">

    <!-- LEFT: lista de productos -->
    <section class="cart-left">
      <div class="cart-hero">
        <h1>üõí <%= t("carrito.titulo") %></h1>
        <p class="muted">Revisa tu orden, ajusta cantidades y finaliza tu pedido.</p>
      </div>

      <% productos = @productos_en_carrito || [] %>

      <% if productos.empty? %>
        <div class="empty-state">
          <div class="empty-card">
            <i class="fas fa-shopping-cart icon-lg"></i>
            <h3><%= t("carrito.vacio") %></h3>
            <p>Todav√≠a no agregaste nada. Explora el men√∫ y agrega tus favoritos.</p>
            <%= link_to t("botones.volver_categorias"), grupo_index_path, class: "btn-cta-primary" %>
          </div>
        </div>
      <% else %>
        <ul class="cart-list" id="cartList">
          <% productos.each do |producto| %>
            <% cantidad = (session[:carrito] || []).count(producto.id.to_s) %>
            <li class="cart-item" data-product-id="<%= producto.id %>">
              <div class="item-left">
                <% if producto.foto.attached? %>
                  <%= image_tag producto.foto.variant(resize_to_limit: [160,160]), alt: producto.name, class: "item-thumb" %>
                <% else %>
                  <%= image_tag "sin_imagen.png", alt: producto.name, class: "item-thumb" %>
                <% end %>
                <div class="item-info">
                  <div class="title-row">
                    <strong class="item-name"><%= producto.name %></strong>
                    <%# badge ejemplo: si est√° en oferta %>
                    <% if producto.respond_to?(:oferta) && producto.oferta.present? %>
                      <span class="badge">Oferta</span>
                    <% end %>
                  </div>
                  <p class="item-desc"><%= truncate(producto.descripcion || "", length: 80) %></p>

                  <div class="controls-row">
                    <div class="qty-controls" role="group" aria-label="Controles de cantidad">
                      <%= button_to "-", reducir_del_carrito_path(producto.id.to_s), method: :post, class: "qty-btn minus", form: { "data-remote": true } %>
                      <span class="qty-value" aria-live="polite"><%= cantidad %></span>
                      <%= button_to "+", agregar_al_carrito_path(producto.id.to_s), method: :post, class: "qty-btn plus", form: { "data-remote": true } %>
                    </div>

                    <div class="price-block">
                      <div class="line-total"> $<%= number_with_delimiter(producto.precio * cantidad, delimiter: '.') %> </div>
                      <div class="unit">(<%= t("carrito.precio_unitario") %>: $<%= number_with_delimiter(producto.precio, delimiter: '.') %>)</div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="item-actions">
                <%= button_to t("carrito.eliminar"), eliminar_del_carrito_path(producto.id), method: :delete, class: "btn-icon-remove", form: { "data-remote": true } %>
              </div>
            </li>
          <% end %>
        </ul>
      <% end %>
    </section>

    <!-- RIGHT: panel resumen -->
    <aside class="cart-right" id="cartSummary" aria-live="polite">
      <div class="summary-card">
        <div class="summary-head">
          <h3>Resumen</h3>
          <small class="muted">Tu orden est√° casi lista</small>
        </div>

        <% # calcular subtotal, impuestos y total en la vista (puedes refactorizar al helper) %>
        <% subtotal = 0 %>
        <% productos.each do |p| %>
          <% qty = (session[:carrito] || []).count(p.id.to_s) %>
          <% subtotal += p.precio * qty %>
        <% end %>
        <% tax_rate = 0.19 %> <!-- ejemplo 19% -->
        <% impuestos = (subtotal * tax_rate).round %>
        <% total = subtotal + impuestos %>

        <div class="summary-lines">
          <div class="line"><span>Subtotal</span><span>$<%= number_with_delimiter(subtotal, delimiter: '.') %></span></div>
          <div class="line"><span>Impuestos (19%)</span><span>$<%= number_with_delimiter(impuestos, delimiter: '.') %></span></div>
          <div class="line discount"><span>Descuento</span><span>- $0</span></div>
          <div class="total-line"><strong>Total</strong><strong>$<%= number_with_delimiter(total, delimiter: '.') %></strong></div>
        </div>

        <div class="summary-actions">
          <% if productos.present? %>
            <%= link_to "üí≥ " + t("carrito.finalizar"), new_checkout_path, class: "btn-primary btn-block" %>
            <%= link_to "üîÅ Seguir comprando", grupo_index_path, class: "btn-outline btn-block" %>
          <% else %>
            <%= link_to t("botones.volver_categorias"), grupo_index_path, class: "btn-outline btn-block" %>
          <% end %>
        </div>

        <div class="summary-footer">
          <small class="muted">Entrega estimada: 20-30 min ‚Ä¢ Pago con tarjeta o efectivo</small>
        </div>
      </div>
    </aside>
  </div>
</div>